{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="{% static 'ponno/css/product_detail.css'%}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
   
    <title>Product Deatail</title>
 
</head>

<body>

<!-- Navigation Bar -->
<div class="menu-top">
    <div class="container-fluid navbar-container">
        <div class="menu">
            <!-- Logo Section -->          
            <div class="logo-section">
                <a href="#" class="button-class">
                    <div class="logo-container">
                        <span class="navbar-brand"> PIELAM </span>
                    </div>
                </a>
            </div>     
            
       
            <!-- Menu Links -->
            <div class="menu-links">
                <a href="{% url 'ponno:home' %}" class="menu-item icon-button " aria-label="Home">
                    <i class="fa-solid fa-house"></i>
                    <span>Home</span>
                </a>
                <a href="{% url 'notify:notification' %}" class="menu-item icon-button ">
                    <i class="fa-solid fa-bell"></i>
                    <span>Notifications</span>
                </a>
               
                <a href="{% url 'customer:profile' %}" class="menu-item icon-button  aria-label="Profile">
                    <i class="fa-solid fa-circle-user"></i>
                    <span>Profile</span>
                </a>            
            </div>               
        </div>
    </div>
</div>


<!-- Categories List -->
<div class="categories-container">
    <div class="categories-scroll">
      {% for category in categories %}
        <a href="{% url 'ponno:category_products' category.category_slug %}" class="category-badge">
          {{ category.category_name }}
        </a>
      {% empty %}
        <p>No categories found.</p>
      {% endfor %}
    </div>
</div>



<div class="product-container">
    <div class="product-row">
      <div class="product-image-col">
        {% if product.image %}
          <img src="{{ product.image.url }}" alt="{{ product.product_name }}" class="product-image" />
        {% else %}
          <img src="https://via.placeholder.com/400x300?text=No+Image" alt="No Image" class="product-image" />
        {% endif %}
      </div>

      <div class="product-info-col">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
            <h2 class="product-title" style="margin: 0;">{{ product.product_name }}</h2>
          <!-- Share Button -->
            <button id="shareBtn" 
                style="background: #007bff; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 6px;"
                aria-label="Share product">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16" viewBox="0 0 24 24">
                <circle cx="18" cy="5" r="3"></circle>
                <circle cx="6" cy="12" r="3"></circle>
                <circle cx="18" cy="19" r="3"></circle>
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
              </svg>
                  Share
            </button>
        </div>

              <p class="product-badges">
                <span class="badge category-badge">
                  <a href="{% url 'ponno:category_products' product.category.category_slug %}" style="color:white; text-decoration:none;">
                    {{ product.category.category_name }}
                  </a>
                </span>

                <span class="badge brand-badge">
                  <a href="{% url 'ponno:brand_products' product.brand.brand_slug %}" style="color:white; text-decoration:none;">
                    {{ product.brand.brand_name }}
                  </a>
                </span>
              </p>
              <p class="product-price"><strong>Price:</strong> {{ product.brand_price }}Tk</p>
              <p class="product-price"><strong>Price:</strong> {{ product.selling_price }}Tk</p>
              <p class="product-stock"><strong>Stock:</strong> {{ product.stock }}</p>
       
              <!-- üõí Order & Contact Section -->
              <section class="order-section">
                <h2>Order This Product</h2>

                <div class="order-buttons">
                  <!-- WhatsApp -->
                  <a href="https://wa.me/8801538225740?text=I%20want%20to%20buy%20{{ product.product_name }}%20(%20{{ product.brand.brand_name }}%20)%20Price:%20{{ product.brand_price }}TK"
                    target="_blank"
                    class="order-btn whatsapp">
                    <i class="fa-brands fa-whatsapp"></i> Order on WhatsApp
                  </a>

                  <!-- Telegram -->
                  <a href="https://t.me/alifelectronics" target="_blank" class="order-btn telegram">
                    <i class="fa-brands fa-telegram"></i> Order on Telegram
                  </a>

                  <!-- Phone -->
                  <a href="tel:+8801538225740" class="order-btn call">
                    <i class="fa-solid fa-phone"></i> Call to Order
                  </a>

              
              

                </div>
              </section>

<!-- Messenger Chat Plugin -->
                <div id="fb-root"></div>
                <div id="fb-customer-chat" class="fb-customerchat"></div>

      </div>

      <div class="product-description-col">
        <p class="product-description">{{ product.description }}</p>
      </div>
    </div>
</div>

<script>
  // Debounce helper function
  function debounce(func, delay) {
    let timeoutId;
    return function(...args) {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => func.apply(this, args), delay);
    };
  }

  const searchInput = document.getElementById('search-input');
  const resultsContainer = document.getElementById('search-results');

  let currentFocusIndex = -1; // For keyboard navigation

  // Render search results
  function renderResults(products) {
    resultsContainer.innerHTML = '';

    if (products.length === 0) {
      resultsContainer.innerHTML = `<div class="no-results">‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</div>`;
      currentFocusIndex = -1;
      return;
    }

    products.forEach((product, index) => {
      const item = document.createElement('a');
      item.href = `/product/${product.slug}/`;
      item.className = 'search-item';
      item.setAttribute('role', 'option');
      item.setAttribute('id', 'search-item-' + index);
      item.setAttribute('tabindex', '-1');
      item.setAttribute('aria-selected', 'false');

      // Price text
      let priceText = '';
      if (product.brand_price && product.selling_price) {
        priceText = `‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø: ${product.brand_price} TK | ‡¶Ö‡¶´‡¶æ‡¶∞: ${product.selling_price} TK`;
      } else if (product.brand_price) {
        priceText = `‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø: ${product.brand_price} TK`;
      } else if (product.selling_price) {
        priceText = `‡¶Ö‡¶´‡¶æ‡¶∞: ${product.selling_price} TK`;
      } else {
        priceText = `‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡ßü`;
      }

      item.innerHTML = `
        <img src="${product.image}" alt="${product.name}">
        <div class="info">
          <div class="title">${product.name}</div>
          <div class="details">${product.category} / ${product.brand} | ${priceText}</div>
        </div>
      `;

      // Mouse hover sets aria-selected for accessibility
      item.addEventListener('mouseenter', () => {
        setFocus(index);
      });

      item.addEventListener('mouseleave', () => {
        clearFocus();
      });

      resultsContainer.appendChild(item);
    });

    currentFocusIndex = -1;
  }

  // Show results container
  function showResults() {
    resultsContainer.classList.add('show');
    resultsContainer.style.display = 'block';
  }

  // Hide results container
  function hideResults() {
    resultsContainer.classList.remove('show');
    // delay display:none to allow opacity transition
    setTimeout(() => {
      resultsContainer.style.display = 'none';
    }, 250);
    currentFocusIndex = -1;
  }

  // Set focus to a specific item index
  function setFocus(index) {
    const items = resultsContainer.querySelectorAll('.search-item');
    if (items.length === 0) return;

    items.forEach((el, i) => {
      el.setAttribute('aria-selected', 'false');
      el.tabIndex = -1;
    });

    if (index >= 0 && index < items.length) {
      items[index].setAttribute('aria-selected', 'true');
      items[index].tabIndex = 0;
      items[index].focus();
      currentFocusIndex = index;
    }
  }

  // Clear all focus
  function clearFocus() {
    const items = resultsContainer.querySelectorAll('.search-item');
    items.forEach(el => {
      el.setAttribute('aria-selected', 'false');
      el.tabIndex = -1;
    });
    currentFocusIndex = -1;
  }

  // Handle keyboard navigation inside search results
  function handleKeyDown(e) {
    const items = resultsContainer.querySelectorAll('.search-item');
    if (items.length === 0) return;

    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        if (currentFocusIndex < items.length - 1) {
          setFocus(currentFocusIndex + 1);
        } else {
          setFocus(0);
        }
        break;

      case 'ArrowUp':
        e.preventDefault();
        if (currentFocusIndex > 0) {
          setFocus(currentFocusIndex - 1);
        } else {
          setFocus(items.length - 1);
        }
        break;

      case 'Enter':
        if (currentFocusIndex >= 0) {
          e.preventDefault();
          items[currentFocusIndex].click();
        }
        break;

      case 'Escape':
        hideResults();
        searchInput.focus();
        break;
    }
  }

  // Main search function
  function handleSearch() {
    const query = searchInput.value.trim();

    if (!query) {
      hideResults();
      resultsContainer.innerHTML = '';
      return;
    }

    showResults();
    resultsContainer.innerHTML = `<div class="no-results">‡¶Ö‡¶®‡ßÅ‡¶∏‡¶®‡ßç‡¶ß‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>`;

    fetch(`/ajax/search/?q=${encodeURIComponent(query)}`)
      .then(res => res.json())
      .then(data => {
        renderResults(data);
      })
      .catch(() => {
        resultsContainer.innerHTML = `<div class="no-results" style="color:red;">‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶Ü‡¶®‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§</div>`;
      });
  }

  const debouncedSearch = debounce(handleSearch, 300);

  searchInput.addEventListener('input', debouncedSearch);
  searchInput.addEventListener('keydown', handleKeyDown);

  // Close search results if clicked outside
  document.addEventListener('click', (e) => {
    if (!resultsContainer.contains(e.target) && e.target !== searchInput) {
      hideResults();
    }
  });
</script>



<script>
  document.getElementById('shareBtn').addEventListener('click', async () => {
  const shareData = {
    title: "{{ product.product_name|escapejs }}",
    text: "Check out this product on ‡¶Ü‡¶≤‡¶ø‡¶´ ‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶®‡¶ø‡¶ï‡ßç‡¶∏!",
    url: window.location.href
  };

  try {
    if (navigator.share) {
      await navigator.share(shareData);
    } else {
      // fallback: copy URL to clipboard
      await navigator.clipboard.writeText(window.location.href);
      alert('Link copied to clipboard!');
    }
  } catch (err) {
    alert('Error sharing: ' + err.message);
  }
});

</script>

<script>
  var chatbox = document.getElementById('fb-customer-chat');
  chatbox.setAttribute("page_id", "61579317894423");
  chatbox.setAttribute("attribution", "biz_inbox");

  window.fbAsyncInit = function() {
    FB.init({xfbml: true, version: 'v19.0'});
  };

  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "https://connect.facebook.net/en_US/sdk/xfbml.customerchat.js";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>

<!--Start of Tawk.to Script-->
<script type="text/javascript">
    var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
    (function(){
    var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
    s1.async=true;
    s1.src='https://embed.tawk.to/6911d873aadb9719591b726f/1j9mrb181';
    s1.charset='UTF-8';
    s1.setAttribute('crossorigin','*');
    s0.parentNode.insertBefore(s1,s0);
    })();
</script>
<!--End of Tawk.to Script-->

</body>
</html>
